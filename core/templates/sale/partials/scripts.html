<script>
document.addEventListener("DOMContentLoaded", () => {
    const CART_KEY = "stockplus_cart";
    const FORM_KEY = "stockplus_sale_form";

    const cart = loadCart();
    const cartItems = document.getElementById("cart-items");
    const discountField = document.getElementById("discount");
    const summaryItems = document.getElementById("summary-items");
    const summaryTotal = document.getElementById("summary-total");
    const summaryDiscount = document.getElementById("summary-discount");
    const scheduledContainer = document.getElementById("scheduled-container");
    const statusField = document.getElementById("status");
    const customerField = document.getElementById("customer");
    const dateField = document.getElementById("scheduled_date");

    const modal = new bootstrap.Modal(document.getElementById("messageModal"));
    const modalText = document.getElementById("modalMessageText");

    // üß† Utilit√°rio de mensagem
    function showMessage(text) {
        modalText.innerHTML = text;
        modal.show();
    }

    // --- LOCAL STORAGE ---
    function loadCart() {
        try { return JSON.parse(localStorage.getItem(CART_KEY)) || {}; }
        catch { return {}; }
    }
    function saveCart() { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    function clearCart(openingMessage = true) {
        localStorage.removeItem(CART_KEY);
        Object.keys(cart).forEach(k => delete cart[k]);
        renderCart();
        updatePreview();
        if (openingMessage) {
            showMessage("üßπ Carrinho limpo com sucesso!");
        }
    }

    // --- SESSION STORAGE ---
    function saveFormState() {
        const data = {
            customer: customerField.value,
            status: statusField.value,
            discount: discountField.value,
            scheduled_date: dateField.value,
        };
        sessionStorage.setItem(FORM_KEY, JSON.stringify(data));
    }
    function loadFormState() {
        const saved = sessionStorage.getItem(FORM_KEY);
        if (!saved) return;
        try {
            const data = JSON.parse(saved);
            if (data.customer) customerField.value = data.customer;
            if (data.status) statusField.value = data.status;
            if (data.discount) discountField.value = data.discount;
            if (data.scheduled_date) dateField.value = data.scheduled_date;
            scheduledContainer.style.display = data.status === "scheduled" ? "block" : "none";
        } catch (e) {}
    }

    [customerField, statusField, discountField, dateField].forEach(el => {
        el.addEventListener("input", saveFormState);
        el.addEventListener("change", saveFormState);
    });

    // --- Mostrar/ocultar data agendada ---
    statusField.addEventListener("change", () => {
        if (statusField.value === "scheduled") {
            scheduledContainer.style.display = "block";
        } else {
            scheduledContainer.style.display = "none";
            dateField.value = "";
        }
        saveFormState();
    });

    // -- Fun√ß√µes do pesquisar produtos (AJAX) ---
    const searchForm = document.querySelector('#searchForm');
    const productContainer = document.getElementById("product-container");

    if (searchForm) {
        searchForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const query = searchForm.querySelector('input[name="q"]').value.trim();
            await fetchProducts(query, 1);
        });
    }

    // --- Pagina√ß√£o e itens por p√°gina ---
    function attachPaginationEvents() {
        // Bot√µes de p√°gina
        document.querySelectorAll(".page-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const page = btn.dataset.page;
                const perPage = document.getElementById("itemsPerPage")?.value || 10;
                const query = document.querySelector('input[name="q"]').value.trim();
                await fetchProducts(query, page, perPage);
            });
        });

        // Alterar quantidade por p√°gina
        const perPageSelect = document.getElementById("itemsPerPage");
        if (perPageSelect) {
            perPageSelect.addEventListener("change", async () => {
                const perPage = perPageSelect.value;
                const query = document.querySelector('input[name="q"]').value.trim();
                await fetchProducts(query, 1, perPage);
            });
        }
    }


    // --- Fun√ß√£o principal para buscar produtos ---
    async function fetchProducts(query = "", page = 1, perPage = 10) {
        const url = `{% url 'search_products_sale' %}?q=${encodeURIComponent(query)}&page=${page}&per_page=${perPage}`;

        try {
            const response = await fetch(url, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            const data = await response.json();

            if (data.success && data.html) {
                productContainer.innerHTML = data.html;

                // Reanexar eventos
                attachAddToCartEvents();
                attachPaginationEvents();
            }

        } catch (err) {
            console.error("Erro ao carregar produtos:", err);
        }
    }


    // Ativar pagina√ß√£o ap√≥s carregamento inicial
    attachPaginationEvents();
    
    // --- Bot√£o limpar ---
    document.getElementById("clear-cart").addEventListener("click", clearCart);

    // --- Adicionar produto ---
    function attachAddToCartEvents() {
        document.querySelectorAll(".add-to-cart").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.dataset.id;
                const name = btn.dataset.name;
                const basePrice = parseFloat(btn.dataset.price) || 0;
                const stock = parseInt(btn.dataset.stock) || 0;

                if (!cart[id]) cart[id] = { name, quantity: 1, price: basePrice, stock };
                else if (cart[id].quantity < stock) cart[id].quantity += 1;

                saveCart(); renderCart(); updatePreview();
            });
        });
    }

    // --- Renderizar carrinho (igual ao seu original) ---
    function renderCart() {
        cartItems.innerHTML = "";
        const keys = Object.keys(cart);
        if (keys.length === 0) {
            cartItems.innerHTML = "<p class='text-muted small'>Nenhum produto no carrinho.</p>";
            summaryItems.textContent = "0";
            summaryTotal.textContent = "0.00";
            summaryDiscount.textContent = "0.00";
            return;
        }

        keys.forEach(id => {
            const item = cart[id];
            const subtotal = (parseFloat(item.price) || 0) * item.quantity;
            const div = document.createElement("div");
            div.className = "d-flex justify-content-between align-items-center mb-3 p-2 border-bottom border-secondary";

            div.innerHTML = `
                <div class="flex-grow-1">
                    <div class="fw-bold text-truncate">${item.name}</div>
                    <div class="text-muted small">R$ ${Number(item.price).toFixed(2)} cada</div>
                    <div class="mt-1">
                        <input type="number" min="1" max="${item.stock}" value="${item.quantity}" 
                            class="form-control form-control-sm qty-input" 
                            data-id="${id}" style="width: 80px; display:inline-block;">
                        <span class="text-muted small ms-1">/ ${item.stock} unid.</span>
                    </div>
                </div>
                <div class="text-end ms-2" style="min-width:120px">
                    <strong>R$ ${Number(subtotal).toFixed(2)}</strong>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-item" data-id="${id}">‚ùå</button>
                    </div>
                    <input type="hidden" name="product_${id}" value="${item.quantity}">
                </div>
            `;
            cartItems.appendChild(div);
        });

        document.querySelectorAll(".remove-item").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = btn.dataset.id;
                const removed = cart[id].name;
                delete cart[id];
                saveCart(); renderCart(); updatePreview();
            });
        });

        document.querySelectorAll(".qty-input").forEach(input => {
            const id = input.dataset.id;
            input.addEventListener("input", debounce((e) => {
                const value = parseInt(e.target.value) || 1;
                cart[id].quantity = Math.min(value, cart[id].stock);
                saveCart(); renderCart(); updatePreview();
            }, 1000));
        });
    }

    function debounce(func, delay) {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    async function updatePreview() {
        const items = Object.entries(cart).map(([id, it]) => ({
            product_id: id, quantity: it.quantity
        }));
        const discount = parseFloat(discountField.value) || 0;
        if (items.length === 0) {
            summaryItems.textContent = 0;
            summaryTotal.textContent = "0.00";
            summaryDiscount.textContent = discount.toFixed(2);
            return;
        }

        try {
            const response = await fetch("{% url 'sale_preview' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ items, discount })
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            (data.items || []).forEach(it => {
                const key = String(it.product_id);
                if (cart[key]) cart[key].price = Number(it.unit_price);
            });
            saveCart(); renderCart();
            summaryItems.textContent = data.total_quantity || 0;
            summaryDiscount.textContent = Number(data.discount || 0).toFixed(2);
            summaryTotal.textContent = Number(data.total || 0).toFixed(2);
        } catch (err) { console.error("Erro preview:", err); }
    }

    // ----------- ABRIR MODAL DE CONFIRMA√á√ÉO -----------
    document.getElementById("saleForm").addEventListener("submit", (e) => {
        e.preventDefault();
        openConfirmSaleModal();
    });

    function openConfirmSaleModal() {
        const modal = new bootstrap.Modal(document.getElementById("confirmSaleModal"));
        
        document.getElementById("confirmSaleModal").addEventListener("shown.bs.modal", () => {
            loadConfirmFields();
            updateInvoicePreview();
        });

        modal.show();
    }

    // ----------- PREENCER CAMPOS DO LADO DIREITO -----------
    function loadConfirmFields() {
        document.getElementById("confirm_customer").value = customerField.value;
        document.getElementById("confirm_status").value = statusField.value;
        document.getElementById("confirm_discount").value = discountField.value;

        // Mostrar campo data
        document.getElementById("confirm_scheduled_wrapper").style.display =
            statusField.value === "scheduled" ? "block" : "none";

        // Pagamento ‚Üí dinheiro?
        const paymentSelect = document.getElementById("confirm_payment");
        const selected = paymentSelect.options[paymentSelect.selectedIndex];
    }

    // ----------- ATUALIZAR NOTA FISCAL ESQUERDA -----------
    async function updateInvoicePreview() {
        const preview = document.getElementById("invoice-preview");
        preview.innerHTML = "";

        if (Object.keys(cart).length === 0) {
            preview.innerHTML = "<p class='text-muted'>Carrinho vazio.</p>";
            return;
        }

        let html = `
            <div class="thermal-title">Stock Plus</div>
            <div class="thermal-small"><strong>-=-=- Comprovante de Venda -=-=-</strong></div>
            <div class="thermal-small">Isso n√£o √© uma nota fiscal, apenas um comprovante de venda.</div>
            <div class="thermal-section"></div>
        `;

        // Se custumer for diferente de Cliente Avulso de ID 1, mostrar informa√ßao na nota
        const customerId = document.getElementById("confirm_customer").value;

        if (customerId !== "1") {
            // fazer feach de customer customers/search/
            const response = await fetch(`{% url 'customer_search' %}?q=${customerId}`)
                .then(response => response.json())
            
            const customerName = response.results.length > 0 ? response.results[0].name : "";
            const customerTradeName = response.results.length > 0 ? response.results[0].trade_name : "";
            const customerCnpjCpf = response.results.length > 0 ? response.results[0].cnpj_or_cpf : "";
            const customerPhone = response.results.length > 0 ? response.results[0].phone : "";
            const customerAddress = response.results.length > 0 ? response.results[0].address : "";
            
            html += `
                <div class="thermal-small ">
                    <strong>Raz√£o Social:</strong> ${customerName}<br>
                    <strong>Nome Fantasia:</strong> ${customerTradeName}<br>
                    <strong>CNPJ/CPF:</strong> ${customerCnpjCpf}<br>
                    <strong>Numero:</strong> ${customerPhone}<br>
                    <strong>Endere√ßo:</strong> ${customerAddress}<br>
                </div>
                <div class="thermal-section"></div> 

                <div class="thermal-small">
                    <strong>Produtos</strong>
                </div>
                <div class="thermal-section"></div>
            `;
        }

        Object.values(cart).forEach(item => {
            const subtotal = item.price * item.quantity;

            html += `
                <div class="thermal-small">
                    <strong>${item.name}</strong><br>
                    ${item.quantity} un √ó R$ ${item.price.toFixed(2)}<br>
                    Subtotal: R$ ${subtotal.toFixed(2)}
                </div>
                <div class="thermal-section"></div>
            `;
        });

        const discount = parseFloat(document.getElementById("confirm_discount").value) || 0;
        html += `
            <div class="thermal-small">
                <strong>DESCONTO:</strong> R$ ${discount.toFixed(2)}
            </div>
            <div class="thermal-section"></div>
        `;

        const total = summaryTotal.textContent || "0.00";

        html += `
            <div class="thermal-big"><strong>TOTAL: R$ ${total}</strong></div>
            <div class="thermal-section"></div>
        `;

        const moneyGiven = parseFloat(document.getElementById("money_given").value) || 0;
        const change = Math.round((moneyGiven - parseFloat(total)) / 0.05) * 0.05 || 0;
        if (change >= 0) {
            html += `
                <div class="thermal-small">
                    <strong>DINHEIRO RECEBIDO:</strong> R$ ${moneyGiven.toFixed(2)}<br>
                    <strong>TROCO:</strong> R$ ${change.toFixed(2)}
                </div>
                <div class="thermal-section"></div>
            `;
        }

        preview.innerHTML = html;
    }

    /* ----------------------------------------------
       FUN√á√ïES DO PAGAMENTO EM DINHEIRO
    ---------------------------------------------- */

    document.getElementById("confirm_payment").addEventListener("change", function () {
        const type = this.options[this.selectedIndex].dataset.type;
        toggleMoneyInput(type === "cash");
    });

    function toggleMoneyInput(show) {
        const wrap = document.getElementById("money_wrapper");
        const changeDiv = document.getElementById("change_display");

        if (show) {
            wrap.classList.remove("d-none");
        } else {
            wrap.classList.add("d-none");
            changeDiv.classList.add("d-none");
        }
    }

    // Calcular troco ao digitar
    document.getElementById("money_given").addEventListener("input", () => {
        const total = parseFloat(summaryTotal.textContent);
        const given = parseFloat(document.getElementById("money_given").value) || 0;

        let change = given - total;

        if (change < 0) {
            document.getElementById("change_display").classList.add("d-none");
            return;
        }

        change = Math.round(change / 0.05) * 0.05;

        document.getElementById("change_value").textContent = change.toFixed(2);
        document.getElementById("change_display").classList.remove("d-none");
    });


    /* ----------------------------------------------
       FINALIZAR VENDA
    ---------------------------------------------- */

    const confirmSaleButton = document.getElementById("confirmSaleButtonModal");

    confirmSaleButton.addEventListener("click", async () => {
        const customer = document.getElementById("confirm_customer").value;
        const status = document.getElementById("confirm_status").value;
        const discount = parseFloat(document.getElementById("confirm_discount").value) || 0;
        const scheduledDate = document.getElementById("confirm_scheduled_date").value;
        const paymentMethod = document.getElementById("confirm_payment").value;

        const items = Object.entries(cart).map(([id, it]) => ({
            product_id: id,
            quantity: it.quantity
        }));

        const body = {
            customer,
            status,
            discount,
            scheduled_date: scheduledDate,
            payment_method: paymentMethod,
            items
        };

        try {
            const response = await fetch("{% url 'sale_create' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(body)
            });

            const data = await response.json();
            if (!data.success) throw new Error(data.error);

            /* --------------------------------------
               SE PAGAMENTO FOR DINHEIRO ‚Üí MODAL TROCO
            -------------------------------------- */

            const paymentType =
                document.getElementById("confirm_payment")
                .selectedOptions[0].dataset.type;

            if (paymentType === "cash") {
                const total = parseFloat(summaryTotal.textContent);
                const given = parseFloat(document.getElementById("money_given").value) || 0;

                let change = given - total;
                if (change < 0) change = 0;

                change = Math.round(change / 0.05) * 0.05;

                document.getElementById("changeFinalValue").textContent =
                    change.toFixed(2);

                const modal = new bootstrap.Modal(document.getElementById("changeModal"));
                modal.show();
                
                // Fechar modal de finaliza√ß√£o de venda
                const confirmModalEl = document.getElementById("confirmSaleModal");
                const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
                confirmModal.hide();

                // Esperar fechar o modal de troco
                modalEl = document.getElementById("changeModal");
                modalEl.addEventListener('hidden.bs.modal', function () {
                    clearCart(false);
                    sessionStorage.removeItem(FORM_KEY);

                    // retornar para a p√°gina de vendas (para novas vendas)
                    window.location.href = `{% url 'sale'%}`;
                });

                return;
            }

            clearCart(false);
            sessionStorage.removeItem(FORM_KEY);

            // retornar para a p√°gina de vendas (para novas vendas)
            window.location.href = `{% url 'sale'%}`;
        } catch (err) {
            showMessage("‚ùå Erro ao concluir venda: " + err.message);
        }
    });

    document.getElementById("confirm_discount").addEventListener("change", function() {
        document.getElementById("discount").value = this.value;
        updatePreview();
    });

    /* ----------------------------------------------
       ATUALIZAR NOTA FISCAL ESQUERDA
    ---------------------------------------------- */
    const formConfirmSaleModal = document.getElementById("confirmSaleForm");
    const discountConfirmField = document.getElementById("confirm_discount");
    // Atualizar ao mudar qualquer campo, apos 1 segundo
    formConfirmSaleModal.addEventListener("input", debounce(updateInvoicePreview, 1000));
    formConfirmSaleModal.addEventListener("change", debounce(updateInvoicePreview, 1000));
    discountConfirmField.addEventListener("input", debounce(updatePreview, 1000));
    discountConfirmField.addEventListener("change", debounce(updatePreview, 1000));
    // reacualcular troco ao mudar valor dado
    document.getElementById("money_given").addEventListener("input", debounce(updateInvoicePreview, 1000));

    // --- Inicializa√ß√£o ---
    loadFormState();
    attachAddToCartEvents();
    renderCart();
    updatePreview();
});
</script>