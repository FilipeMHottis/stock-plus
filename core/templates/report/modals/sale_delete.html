<div class="modal fade" id="deleteSaleModal" tabindex="-1" aria-labelledby="deleteSaleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title" id="deleteSaleModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body bg-dark text-light">
                <p>Tem certeza de que deseja excluir esta venda? Esta ação não pode ser desfeita.</p>
            </div>

            <div class="modal-footer bg-dark">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="sale_id" id="delete-sale-id" value="">
                    <button type="submit"  class="btn btn-danger">Excluir Venda</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
window.loadSales = window.loadSales || function() {
    // Função placeholder para recarregar a tabela de vendas
    // Deve ser implementada na página que inclui este modal
    console.log("loadSales function not implemented.");
};

document.addEventListener('DOMContentLoaded', function() {
    const deleteSaleModal = document.getElementById('deleteSaleModal');
    const deleteForm = deleteSaleModal.querySelector('form');
    let deleteURL = '';
    
    deleteSaleModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const saleId = button.getAttribute('data-sale-id');
        const inputSaleId = deleteSaleModal.querySelector('#delete-sale-id');
        inputSaleId.value = saleId;
        deleteURL = `/sales/delete/${saleId}/`;
    });

    deleteForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        try {
            const response = await fetch(deleteURL, {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken }
            });

            const data = await response.json();

            if (data.success) {
                // Fecha modal
                bootstrap.Modal.getInstance(deleteSaleModal).hide();

                window.location.reload();
            } else {
                alert("Erro ao deletar: " + (data.error || "Erro desconhecido."));
            }

        } catch (err) {
            alert("Falha na requisição: " + err);
        }
    });
});
</script>
