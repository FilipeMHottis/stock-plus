<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <form method="post" id="paymentForm">
                {% csrf_token %}
                <div class="modal-header bg-purple text-white">
                    <h5 class="modal-title" id="paymentModalLabel">Novo M√©todo de Pagamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="id" id="form-id">

                    <!-- Nome -->
                    <div class="mb-3">
                        <label for="form-name" class="form-label fw-bold">Nome do M√©todo</label>
                        <input type="text" name="name" id="form-name" class="form-control" required>
                    </div>

                    <!-- Tipo -->
                    <div class="mb-3">
                        <label for="form-type" class="form-label fw-bold">Tipo de Pagamento</label>
                        <select name="type" id="form-type" class="form-select" required>
                            <option value="cash">üíµ Dinheiro</option>
                            <option value="pix">‚ö° PIX</option>
                            <option value="debit">üèß Cart√£o de D√©bito</option>
                            <option value="credit">üí≥ Cart√£o de Cr√©dito</option>
                            <option value="boleto">üìÑ Boleto</option>
                            <option value="other">üîπ Outro</option>
                        </select>
                    </div>

                    <!-- Taxa Interna -->
                    <div class="mb-3">
                        <label for="form-internal-fee" class="form-label fw-bold">Taxa Interna (%)</label>
                        <input type="number" step="0.01" min="0" name="internal_fee" id="form-internal-fee" class="form-control" value="0">
                        <div class="form-text text-muted small">Taxa cobrada pela operadora (reduz o lucro l√≠quido).</div>
                    </div>

                    <hr class="border-secondary">

                    <!-- Configura√ß√µes de Parcelamento -->
                    <div id="installment-section" style="display: none;">
                        <h6 class="fw-bold mb-3">Configura√ß√µes de Parcelamento</h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="form-min-amount" class="form-label">Valor M√≠nimo para Parcelar (R$)</label>
                                <input type="number" step="0.01" min="0" name="min_installment_amount" id="form-min-amount" class="form-control" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="form-max-installments" class="form-label">M√°ximo de Parcelas</label>
                                <input type="number" min="1" name="max_installments" id="form-max-installments" class="form-control" value="1">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="form-no-interest" class="form-label">Parcelas Sem Juros</label>
                                <input type="number" min="1" name="no_interest_installments" id="form-no-interest" class="form-control" value="1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="form-customer-rate" class="form-label">Juros ao Cliente (%) ao m√™s</label>
                                <input type="number" step="0.01" min="0" name="customer_interest_rate" id="form-customer-rate" class="form-control" value="0">
                            </div>
                        </div>
                    </div>

                    <hr class="border-secondary">

                    <!-- Status -->
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="is_active" id="form-active" checked>
                        <label class="form-check-label" for="form-active">Ativo</label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" id="submit-button">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const typeField = document.getElementById("form-type");
    const installmentSection = document.getElementById("installment-section");
    const modal = document.getElementById("paymentModal");
    const form = document.getElementById("paymentForm");
    const title = document.getElementById("paymentModalLabel");
    const submitButton = document.getElementById("submit-button");

    // üîπ Fun√ß√£o para mostrar/esconder campos de parcelamento
    function toggleInstallmentFields() {
        const value = typeField.value;
        if (value === "credit" || value === "boleto") {
            installmentSection.style.display = "block";
        } else {
            installmentSection.style.display = "none";
            document.getElementById("form-min-amount").value = 0;
            document.getElementById("form-max-installments").value = 1;
            document.getElementById("form-no-interest").value = 1;
            document.getElementById("form-customer-rate").value = 0;
        }
    }

    typeField.addEventListener("change", toggleInstallmentFields);

    // üîπ Preenche campos e define action
    modal.addEventListener("show.bs.modal", (event) => {
        const button = event.relatedTarget;
        const mode = button.getAttribute("data-mode");

        form.reset();

        if (mode === "create") {
            title.textContent = "Novo M√©todo de Pagamento";
            form.action = "/report/payment/create/";
            submitButton.textContent = "Salvar";
        } else if (mode === "edit") {
            title.textContent = "Editar M√©todo de Pagamento";
            const id = button.dataset.id;
            form.action = `/report/payment/update/${id}/`;
            submitButton.textContent = "Atualizar";

            console.log(button.dataset);

            document.getElementById("form-id").value = id;
            document.getElementById("form-name").value = button.dataset.name;
            document.getElementById("form-type").value = button.dataset.type;
            document.getElementById("form-internal-fee").value = button.dataset.internalFee.replace(",", ".");
            document.getElementById("form-min-amount").value = button.dataset.minInstallmentAmount.replace(",", ".");
            document.getElementById("form-max-installments").value = button.dataset.maxInstallments;
            document.getElementById("form-no-interest").value = button.dataset.noInterestInstallments;
            document.getElementById("form-customer-rate").value = button.dataset.customerInterestRate.replace(",", ".");
            document.getElementById("form-active").checked = button.dataset.active === "True";
        }

        toggleInstallmentFields(); // garante exibi√ß√£o correta
    });
});
</script>

<style>
#installment-section {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 0.5rem;
    padding: 1rem;
}
.bg-purple {
    background-color: #4B0082 !important;
}
</style>
