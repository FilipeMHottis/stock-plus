{% extends "base.html" %}

{% block title %}Categorias - Stock Plus{% endblock %}

{% block content %}
<div class="card shadow-lg border-0 rounded-3">
    <div class="card-header d-flex justify-content-between align-items-center bg-purple text-white">
        <h2 class="mb-0">Categorias</h2>

        {% if user.role == "manager" or user.role == "admin" %}
        <button class="btn btn-light text-purple fw-bold" data-bs-toggle="modal" data-bs-target="#categoryModal" data-mode="create">
            ‚ûï Nova Categoria
        </button>
        {% endif %}
    </div>

    <div class="card-body bg-dark text-light">
        <table class="table table-dark table-striped table-hover align-middle rounded-3 overflow-hidden">
            <thead class="bg-purple text-white">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Faixa 1</th>
                    <th>Faixa 2</th>
                    <th>Faixa 3</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for category in categories %}
                <tr>
                    <td>{{ category.id }}</td>
                    <td>{{ category.name }}</td>
                    <td>R$ {{ category.price_tier_1 }}</td>
                    <td>{% if category.price_tier_2 %}R$ {{ category.price_tier_2 }}{% else %}-{% endif %}</td>
                    <td>{% if category.price_tier_3 %}R$ {{ category.price_tier_3 }}{% else %}-{% endif %}</td>
                    <td>
                        <button 
                            class="btn btn-sm btn-outline-info"
                            data-bs-toggle="modal"
                            data-bs-target="#detailsModal"
                            data-id="{{ category.id }}"
                            data-name="{{ category.name }}"
                            data-price1="{{ category.price_tier_1 }}"
                            data-price2="{{ category.price_tier_2 }}"
                            data-price3="{{ category.price_tier_3 }}"
                            data-qty1="{{ category.quantity_limit_1 }}"
                            data-qty2="{{ category.quantity_limit_2 }}">
                            üîç Detalhes
                        </button>

                        {% if user.role == "manager" or user.role == "admin" %}
                        <button 
                            class="btn btn-sm btn-outline-warning text-white"
                            data-bs-toggle="modal"
                            data-bs-target="#categoryModal"
                            data-mode="edit"
                            data-category-id="{{ category.id }}"
                            data-name="{{ category.name }}"
                            data-price1="{{ category.price_tier_1 }}"
                            data-price2="{{ category.price_tier_2 }}"
                            data-price3="{{ category.price_tier_3 }}"
                            data-qty1="{{ category.quantity_limit_1 }}"
                            data-qty2="{{ category.quantity_limit_2 }}">
                            ‚úèÔ∏è Editar
                        </button>
                        {% endif %}

                        {% if user.role == "admin" %}
                        <button
                            class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteModal"
                            data-id="{{ category.id }}">
                            üóëÔ∏è
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">Nenhuma categoria encontrada.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Cria√ß√£o/Edi√ß√£o -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <form method="post" id="categoryForm">
                {% csrf_token %}
                {% include 'category/category_form.html' %}
            </form>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title" id="detailsModalLabel">Detalhes da Categoria</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsBody"></div>
        </div>
    </div>
</div>

<!-- Modal de Exclus√£o -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title">Excluir Categoria</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Tem certeza de que deseja excluir esta categoria?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="post" id="deleteForm">
                    {% csrf_token %}
                    <input type="hidden" name="category_id" id="deleteCategoryId">
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('categoryModal');
    const form = document.getElementById('categoryForm');
    const submitButton = document.getElementById('submit-button');

    // helper: transforma "None"/"null"/undefined em ""
    const safeValue = (v) => {
        if (v === null || v === undefined) return "";
        if (typeof v === "string") {
            if (v === "None" || v === "null") return "";
            return v;
        }
        return String(v);
    };

    // helper: normaliza v√≠rgula->ponto e corta espa√ßos
    const normalizeNumberString = (s) => {
        if (!s) return "";
        return String(s).trim().replace(',', '.');
    };

    const setInputValue = (el, rawValue) => {
        if (!el) return;
        const v = normalizeNumberString(safeValue(rawValue));
        // se √© um input number, tentar formatar com 2 casas (mant√©m string se inv√°lida)
        if (el.type === 'number' && v !== "") {
            // tenta converter para n√∫mero e formatar, se falhar coloca raw
            const n = Number(v);
            if (!Number.isNaN(n)) {
                // remove not necessary trailing zeros? mantemos 2 casas pra consist√™ncia
                el.value = Number(n.toFixed(2));
            } else {
                el.value = v;
            }
        } else {
            el.value = v;
        }
    };

    function setupDynamicFieldLocking(isEditMode) {
        const price1 = document.getElementById('form-price1');
        const qty1 = document.getElementById('form-qty1');
        const price2 = document.getElementById('form-price2');
        const qty2 = document.getElementById('form-qty2');
        const price3 = document.getElementById('form-price3');

        // remove listeners antigos (defensivo) -> recria cloning
        [price1, qty1, price2, qty2].forEach(el => {
            if (!el) return;
            const clone = el.cloneNode(true);
            el.parentNode.replaceChild(clone, el);
        });

        // re-query after replace
        const p1 = document.getElementById('form-price1');
        const q1 = document.getElementById('form-qty1');
        const p2 = document.getElementById('form-price2');
        const q2 = document.getElementById('form-qty2');
        const p3 = document.getElementById('form-price3');

        if (isEditMode) {
            [p1, q1, p2, q2, p3].forEach(el => { if (el) el.disabled = false; });
            return;
        }

        // modo create: trava progressivamente
        if (q1) q1.disabled = true;
        if (p2) p2.disabled = true;
        if (q2) q2.disabled = true;
        if (p3) p3.disabled = true;

        if (p1) p1.addEventListener('input', () => {
            q1.disabled = p1.value.trim() === '';
        });
        if (q1) q1.addEventListener('input', () => {
            p2.disabled = q1.value.trim() === '';
        });
        if (p2) p2.addEventListener('input', () => {
            q2.disabled = p2.value.trim() === '';
        });
        if (q2) q2.addEventListener('input', () => {
            p3.disabled = q2.value.trim() === '';
        });
    }

    modal.addEventListener('show.bs.modal', (event) => {
        const button = event.relatedTarget;
        const mode = (button && button.getAttribute('data-mode')) || 'create';
        const title = modal.querySelector('.modal-title');

        if (mode === 'edit') {
            title.textContent = 'Editar Categoria';
            form.action = `/categories/update/${button.getAttribute('data-id')}/`;
            submitButton.textContent = 'Atualizar';

            // reset antes de preencher (mant√©m atributos default do form)
            form.reset();

            // habilita campos (modo edi√ß√£o)
            setupDynamicFieldLocking(true);

            // pega os valores direto do atributo (mais robusto que dataset em alguns casos)
            setInputValue(document.getElementById('form-id'), button.getAttribute('data-id'));
            setInputValue(document.getElementById('form-name'), button.getAttribute('data-name'));

            // price fields -> normaliza v√≠rgulas/pontos
            setInputValue(document.getElementById('form-price1'), button.getAttribute('data-price1'));
            setInputValue(document.getElementById('form-price2'), button.getAttribute('data-price2'));
            setInputValue(document.getElementById('form-price3'), button.getAttribute('data-price3'));

            // qty fields
            setInputValue(document.getElementById('form-qty1'), button.getAttribute('data-qty1'));
            setInputValue(document.getElementById('form-qty2'), button.getAttribute('data-qty2'));

        } else {
            title.textContent = 'Nova Categoria';
            form.action = '/categories/create/';
            submitButton.textContent = 'Salvar';
            form.reset();
            setupDynamicFieldLocking(false);
        }
    });

    // details modal (mantido)
    const detailsModal = document.getElementById('detailsModal');
    if (detailsModal) {
        detailsModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const body = document.getElementById('detailsBody');
            body.innerHTML = `
                <p><strong>Nome:</strong> ${safeValue(button.getAttribute('data-name'))}</p>
                <p><strong>Faixa 1:</strong> R$ ${safeValue(button.getAttribute('data-price1'))} at√© ${safeValue(button.getAttribute('data-qty1')) || '-'} unidades</p>
                <p><strong>Faixa 2:</strong> ${button.getAttribute('data-price2') ? `R$ ${safeValue(button.getAttribute('data-price2'))} at√© ${safeValue(button.getAttribute('data-qty2')) || '-'} unidades` : '-'}</p>
                <p><strong>Faixa 3:</strong> ${button.getAttribute('data-price3') ? `R$ ${safeValue(button.getAttribute('data-price3'))} acima de ${safeValue(button.getAttribute('data-qty2')) || '-'} unidades` : '-'}</p>
            `;
        });
    }

    // delete modal
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-id');
            document.getElementById('deleteCategoryId').value = id;
            deleteModal.querySelector('form').action = `/categories/delete/${id}/`;
        });
    }
});
</script>
{% endblock %}
