{% extends "base.html" %}

{% block title %}Categories - Stock Plus{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2>Categories</h2>

        {% if user.role in "manager admin" %}
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" data-mode="create">
            ‚ûï Adicionar Categoria
        </button>
        {% endif %}
    </div>

    <div class="card-body">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Faixa de Pre√ßo 1</th>
                    <th>Faixa de Pre√ßo 2</th>
                    <th>Faixa de Pre√ßo 3</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for category in categories %}
                <tr>
                    <td>{{ category.id }}</td>
                    <td>{{ category.name }}</td>
                    <td>R$ {{ category.price_tier_1 }}</td>
                    <td>{% if category.price_tier_2 %}R$ {{ category.price_tier_2 }}{% else %}-{% endif %}</td>
                    <td>{% if category.price_tier_3 %}R$ {{ category.price_tier_3 }}{% else %}-{% endif %}</td>
                    <td>
                        <button 
                            class="btn btn-sm btn-info"
                            data-bs-toggle="modal"
                            data-bs-target="#detailsModal"
                            data-id="{{ category.id }}"
                            data-name="{{ category.name }}"
                            data-price1="{{ category.price_tier_1 }}"
                            data-price2="{{ category.price_tier_2 }}"
                            data-price3="{{ category.price_tier_3 }}"
                            data-qty1="{{ category.quantity_limit_1 }}"
                            data-qty2="{{ category.quantity_limit_2 }}"
                        >
                            üîç Detalhes
                        </button>

                        {% if user.role in "manager admin" %}
                        <button 
                            class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#categoryModal"
                            data-mode="edit"
                            data-id="{{ category.id }}"
                            data-name="{{ category.name }}"
                            data-price1="{{ category.price_tier_1 }}"
                            data-price2="{{ category.price_tier_2 }}"
                            data-price3="{{ category.price_tier_3 }}"
                            data-qty1="{{ category.quantity_limit_1 }}"
                            data-qty2="{{ category.quantity_limit_2 }}"
                        >
                            ‚úèÔ∏è Editar
                        </button>

                        {% if user.role == "admin" %}
                        <button
                            class="btn btn-sm btn-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteModal"
                            data-id="{{ category.id }}"
                        >
                            üóëÔ∏è Deletar
                        </button>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">Categorias n√£o encontradas.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Adi√ß√£o/Edi√ß√£o -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="categoryForm">
                {% csrf_token %}
                {% include 'category/category_form.html' %}
            </form>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Detalhes da Categoria</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsBody">
                <!-- Conte√∫do preenchido via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Modal de Exclus√£o -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Tem certeza de que deseja excluir esta categoria?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="post" id="deleteForm">
                    {% csrf_token %}
                    <input type="hidden" name="category_id" id="deleteCategoryId">
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('categoryModal');
    modal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const mode = button.getAttribute('data-mode');
        const form = modal.querySelector('form');
        const title = modal.querySelector('.modal-title');
        const submitButton = document.getElementById('submit-button');

        if (mode === 'edit') {
            title.textContent = 'Editar Categoria';
            form.action = `/categories/update/${button.dataset.id}/`;
            submitButton.textContent = 'Atualizar';

            document.getElementById('form-id').value = button.dataset.id;
            document.getElementById('form-name').value = button.dataset.name;
            document.getElementById('form-price1').value = button.dataset.price1;
            document.getElementById('form-price2').value = button.dataset.price2;
            document.getElementById('form-price3').value = button.dataset.price3;
            document.getElementById('form-qty1').value = button.dataset.qty1;
            document.getElementById('form-qty2').value = button.dataset.qty2;
            document.getElementById('form-qty3').value = button.dataset.qty3;
        } else {
            title.textContent = 'Nova Categoria';
            form.action = '/categories/create/';
            submitButton.textContent = 'Salvar';
            form.reset();
        }
    });

    const detailsModal = document.getElementById('detailsModal');
    detailsModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const body = document.getElementById('detailsBody');
        body.innerHTML = `
            <p><strong>Nome:</strong> ${button.dataset.name}</p>
            <p><strong>Faixa de Pre√ßo 1:</strong> R$ ${button.dataset.price1} aplicado at√© limite de quantidade ${button.dataset.qty1}</p>
            <p><strong>Faixa de Pre√ßo 2:</strong> ${button.dataset.price2 ? `R$ ${button.dataset.price2} aplicado at√© limite de quantidade ${button.dataset.qty2}` : '-'}</p>
            <p><strong>Faixa de Pre√ßo 3:</strong> ${button.dataset.price3 ? `R$ ${button.dataset.price3}` : '-'} aplicado acima de quantidade ${button.dataset.qty2}</p>
        `;
    });

    const deleteModal = document.getElementById('deleteModal');
    deleteModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const id = button.dataset.id;
        const form = deleteModal.querySelector('form');
        document.getElementById('deleteCategoryId').value = id;
        form.action = `/categories/delete/${id}/`;
    });
});
</script>
{% endblock %}
